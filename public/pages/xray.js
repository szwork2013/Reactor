// Generated by CoffeeScript 1.6.3
var barcode, clear, get_record, input, pattern, record_template;

input = '';

pattern = /^\d{8}$/;

record_template = $('#record_template');

barcode = '';

get_record = function(bcode) {
  return $.ajax({
    type: 'get',
    url: "/records/" + bcode + "/profile",
    success: function(profile) {
      return $.ajax({
        type: 'get',
        url: "/records/" + bcode + "/images",
        success: function(images) {
          var html;
          barcode = bcode;
          images = images.filter(function(image) {
            return image.tag[0] === '放';
          }).map(function(image) {
            var obj, tag;
            tag = image.tag.substring(image.tag.lastIndexOf(':') + 1);
            obj = {};
            obj[tag] = {
              _id: image._id,
              tag: tag
            };
            return obj;
          });
          console.log(images);
          console.log(profile);
          html = Mustache.render(record_template.html(), {
            profile: profile,
            images: images
          });
          return $('body').html(html);
        },
        error: function() {
          alert('查询图片出错...');
          return clear();
        }
      });
    },
    error: function() {
      barcode = '';
      clear();
      return alert('没有找到此档案信息...');
    }
  });
};

clear = function() {
  return $('body').empty();
};

document.addEventListener('keydown', function(event) {
  var code, str;
  if (event.keyCode === 13) {
    if (input.length >= 8) {
      str = input.substring(input.length - 8);
      if (pattern.test(str)) {
        get_record(str);
      }
    }
    return input = '';
  } else {
    code = event.keyCode;
    if (event.keyCode >= 96 && event.keyCode <= 105) {
      code = code - 48;
    }
    return input += String.fromCharCode(code);
  }
});

$('select').live('change', function() {
  var t;
  t = $(this);
  return $.ajax({
    type: 'put',
    url: "/records/" + barcode + "/images/" + (t.attr('_id')) + "/tag/放射科:" + (t.val()),
    success: function() {
      console.log('修改成功');
      return t.attr('class', t.val());
    },
    error: function() {
      alert('修改失败...');
      return t.val(t.attr('class'));
    }
  });
});
